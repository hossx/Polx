#Bitgame - 比特币游戏资产管理引擎

##现状

游戏内购买现在主要用法币。目前法币充值途径多样，但对于用户来讲，游戏内消费存在下列问题：
- 不能提现：充值即已经消费，游戏内的资产无论以任何形式存在，都只存在游戏内部。
- 不能转移：游戏中的资产，无法转移到其它的游戏中去。某些公司可能有自己公司的XX币，但也只限于自己公司内部的游戏间流通。

以上问题对于游戏运营者反而是有利的，因为可以大大增加收入。但如果我们从用户的角度出发，如果能解决上述的问题，用户应该愿意买单。如果我们的方案也可以允许游戏运营商通过一种新的模式赚钱，推广起来可能更容易。


##比特币
比特币是去中心化的电子货币，用比特币来标的用户在游戏中的资产是非常合适的。而且其转账成本很低。


##平台设计目标

我们希望本平台能为多家公司的多款游戏提供用户比特币资产的维护和管理功能。对于用户而言，只需要通过该平台就可以为多款游戏进行充值提现；对于游戏运营商而言，完全可以忽略充值提现，但却可以对用户的部分资产进行操作（交易），从而赚取提成或者手续费。游戏运营商也是通过该平台进行比特币提现（后续我们还会允许商户提取美金或者人民币，这点和游戏用户不同）。


##账号
我们假设平台上有三个用户A，B，C，两个游戏运营商X，Y，分别运行游戏 x1, x2, y。  

###主账号
平台对于上述场景，将生成和维护A, B, C三个用户的主账号: #A, #B, #C；为X，Y生成##X, ##Y两个运营商主账号。

所有充值提现操作只能在主账号下进行操作。

###虚拟账号
对于3款游戏，我们为其生成并维护虚拟账号 $x1, $x2, $y，其中前两个与##X关联，后一个与##Y关联。

 主账号 | ##X | ##Y | #A |#B | #C
------------ | ------------- | ------------| ------------- | ------------| ------------
x1虚拟账号 | $X_x1  |   （无）   | $A_x1  | $B_x1| $C_x1
x2虚拟账号 | $X_x2  |   （无）    |（没玩）| $B_x2| （没玩）
y 虚拟账号 |    （无）     | $Y_y | $A_x1  |（没玩）| （没玩）

运营商的虚拟账号需要平台手动添加；而用户的虚拟账号是在游戏开始游戏的时候自动创建和销毁的。

####游戏后台对虚拟账号的操作
在上面的例子中，运营商X将有权利通过API操作第一第二列的所有账号，即对其中的账号进行转账操作；运营商Y有权对第三列所有虚拟账号进行操作。操作有两种：

- 转账：将资产在一列中的几个虚拟账号中进行再分配，比如：
```
transaction: {
	input: {
		'$A_x1': 1000,
		'$B_x1': 2000
	},
	output: {
		'$C_x1': 2500,
		‘$X_x’: 500
	}
}	
```
转账操作需要确保转入数量和转出数量总和一致。

- 提现：将运营商虚拟账号中的资产转移到主账号中
```
transfer: {
	input: {
		‘$X_x’: 5000
	},
	output: {
		'##X': 5000
	}
}	
```

####用户对虚拟账号的操作
用户操作相对简单，只能在自己的主账号和虚拟账号间进行转账。

####虚拟账号注销
平台在一个虚拟账号不活跃一定时间之后，自动将虚拟账号的余额转到主账号，并且注销虚拟账号。

##高频操作以及带来的性能问题
设想一款21点（blackjack）赌博游戏，如果每次用户下注，游戏后台都进行一个上述的transaction操作，那么这种操作的频次非常高。而且这种操作需要从用户手机客户端，发送到游戏后台，游戏后台再同本平台进行交互，会造成较高的延迟而影响用户体验。

###解决方案 - 虚拟账号锁定
我们可以允许游戏后台发送API锁定用户某个虚拟账号，并得到该虚拟账号的余额。
```
lock: {
	accounts: [
		'$A_x1'
	]
}	
```
返回
```
locked: [{
	account: '$A_x1',
	balance: 2000
}]	
```
锁定后，用户对该虚拟账号的操作将会被放到队列里，等到该账号解锁时候自动执行。游戏服务器拿到locked结果后，可以在本地缓存起来，并且在本地对多个锁定账号进行操作。举个例子，如果游戏后台锁定了 $A_x，$B_x1两个账号（余额分别是2000, 1000），并且经过几轮本地操作，将两个账号余额变成（1500，1500）。这时候，游戏后台可以通过API解锁两个账号：
```
unlock: {
	lock-again: false,
	[{
		account: '$A_x1',
		balance: 1500
	},
		{
		account: '$B_x1',
		balance: 1500
	}]
}
```
游戏后台可以指定是否在unlock之后立即重新lock账号。注意，在账号重新lock之后的余额可能与之前的unlock指定的值不一致。这主要是用户被挂起的操作在账号unlock后可能被成功执行。


###锁定和解锁的原则
任何的lock和unlock操作，都必须保证游戏资产的总和不变。如过API中指定的资产总和与平台信息不一致，缺少的部分将从游戏运营商虚拟账号中扣除，多于部分将会支付给游戏运营商的虚拟账号。

unlock操作和transaction操作一样，遵循原子性原则。即所有涉及的账号要么全部被更新，要么一个也不会被更新。

###最长锁定时常
根据游戏性质的不同，每个游戏的最长锁定时间可以设置成不同的值，比如德州扑克游戏可能就需要十几分钟；而二十一点游戏可能只需要2分钟。有些游戏没有“局”这个概念，可以通过transaction API进行直接转账，避免锁定。

如果游戏服务器在最长锁定时间内没有进行unlock操作，平台将自动进行unlock操作。后续平台发出的unlock操作在余额不住的情况下可能失败。


##平台APP
平台将提供给用户一个APP。通过该APP，用户可以对账号进行操作，充值提现，以及对游戏进行OAuth授权。

##平台盈利模式

- 提现手续费

对用户而言，我们每一笔提现可以会收取一定的手续费，比如2%；对于商户而言，也收取同样的手续费（否者他们将通过一个普通用户来提现）。

- 转账手续费

对于商户的每一个转账操作，我们需要收取一定的手续费，比如5%。我们不收取商户高提现费是因为商户总可以用普通用户的账号进行该操作。
该手续费也可以根据转账是否是通过unlock来进行，还是根据transaction来进行。前者手续费可以更高。后者手续费可以相对较低。

##游戏盈利模式

游戏的盈利模式非常多样。因为转账计算逻辑在游戏后台进行，因此灵活性非常大。


---

##feedback

